name: CD on tag

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            base-devel
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-cmake
            mingw-w64-x86_64-qt6
            mingw-w64-x86_64-qt6-base
            mingw-w64-x86_64-qt6-tools

      - name: Configure and build nsbaci
        run: |
          mkdir -p build
          cd build
          cmake -DCMAKE_BUILD_TYPE=Release ..
          cmake --build . --config Release
        shell: msys2 {0}

      - name: Bundle Qt runtime
        run: |
          cd build
          windeployqt6 nsbaci.exe --release --dir ../build_inno
          cd ..
          cp /mingw64/bin/libgcc_s_seh-1.dll build_inno/
          cp /mingw64/bin/libstdc++-6.dll build_inno/
          cp /mingw64/bin/libwinpthread-1.dll build_inno/

          cp /mingw64/bin/libicuin*.dll build_inno/
          cp /mingw64/bin/libicuuc77.dll build_inno/ || true
          cp /mingw64/bin/libicudt77.dll build_inno/ || true

          cp /mingw64/bin/zlib1.dll build_inno/
          cp /mingw64/bin/libzstd.dll build_inno/
          cp /mingw64/bin/libbz2-1.dll build_inno/
          cp /mingw64/bin/libbrotlidec.dll build_inno/
          cp /mingw64/bin/libbrotlicommon.dll build_inno/

          cp /mingw64/bin/libfreetype-6.dll build_inno/
          cp /mingw64/bin/libharfbuzz-0.dll build_inno/
          cp /mingw64/bin/libpng16-16.dll build_inno/
          cp /mingw64/bin/libgraphite2.dll build_inno/

          cp /mingw64/bin/libpcre2-16-0.dll build_inno/
          cp /mingw64/bin/libpcre2-8-0.dll build_inno/
          cp /mingw64/bin/libb2-1.dll build_inno/
          cp /mingw64/bin/libdouble-conversion.dll build_inno/
          cp /mingw64/bin/libmd4c.dll build_inno/

          cp /mingw64/bin/libglib-2.0-0.dll build_inno/
          cp /mingw64/bin/libintl-8.dll build_inno/
          cp /mingw64/bin/libiconv-2.dll build_inno/
        shell: msys2 {0}

      - name: Install Inno Setup
        run: choco install innosetup --no-progress -y
        shell: pwsh

      - name: Build installer (Inno Setup)
        run: |
          cd installation
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" "nsbaci-installer.iss"
        shell: pwsh

      - name: Upload installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: nsbaci-Windows-Installer
          # Upload the entire directory so path structure is preserved.
          path: build_inno/Output

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            qt6-base-dev \
            qt6-tools-dev \
            qt6-tools-dev-tools \
            libgl1-mesa-dev \
            libxkbcommon-dev \
            libxcb-cursor0 \
            libfuse2 \
            wget

      - name: Configure and build nsbaci
        run: |
          mkdir -p build
          cd build
          cmake -DCMAKE_BUILD_TYPE=Release -DGENERATE_APPIMAGE=ON ..
          cmake --build . --config Release

      - name: Rename AppImage with version
        run: |
          cd build
          mv nsbaci-x86_64.AppImage nsbaci-${{ github.ref_name }}-x86_64.AppImage

      - name: Upload AppImage artifact
        uses: actions/upload-artifact@v4
        with:
          name: nsbaci-Linux-AppImage
          path: build/*.AppImage

  release:
    runs-on: ubuntu-latest
    needs: [build-windows, build-linux]
    permissions:
      contents: write
    steps:
      - name: Checkout repository (for images in release body)
        uses: actions/checkout@v4

      - name: Download Windows artifact
        uses: actions/download-artifact@v4
        with:
          name: nsbaci-Windows-Installer
          path: dist/windows

      - name: Download Linux artifact
        uses: actions/download-artifact@v4
        with:
          name: nsbaci-Linux-AppImage
          path: dist/linux

      - name: List downloaded artifacts (debug)
        run: ls -R dist

      - name: Generate release notes
        id: notes
        uses: actions/github-script@v7
        with:
          script: |
            const { data } = await github.rest.repos.generateReleaseNotes({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: context.ref.replace('refs/tags/', '')
            });
            core.setOutput('notes', data.body);

      - name: Publish release with asset
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body: |
            ## Installation

            ---

            ### ðŸ§ Linux (AppImage)

            The AppImage is a portable executable that works on most Linux distributions without installation.

            #### How to run nsbaci on Linux

            1. Download the `.AppImage` file from the **Assets** section below.
            2. Make the file executable:
               ```bash
               chmod +x nsbaci-*.AppImage
               ```
            3. Run the application:
               ```bash
               ./nsbaci-*.AppImage
               ```

            > **First run:** On the first launch, nsbaci will automatically integrate itself into your system by:
            > - Copying itself to `~/Applications/`
            > - Creating a desktop entry in your application menu
            > - Installing icons for your desktop environment

            #### Uninstalling on Linux

            To uninstall nsbaci, run:
            ```bash
            ~/Applications/nsbaci.AppImage --uninstall
            ```

            > **Note:** If you encounter a *"FUSE not found"* error, install FUSE with:
            > ```bash
            > sudo apt install libfuse2   # Debian/Ubuntu
            > sudo dnf install fuse-libs  # Fedora
            > ```

            ---

            ### ðŸªŸ Windows

            #### Windows Security Notice

            When running the nsbaci **installer** (`nsbaci-installer-*.exe`), Windows may display a **"Windows protected your PC"** warning.  
            This is expected and happens because the executable is not digitally signed (I don't have the resources to purchase a digital certificate :) ).

            This application is completely safe to use and does **not** contain any malware.  
            The warning appears simply because the installer is unsigned and new.

            #### How to install nsbaci on Windows

            1. Download the `.exe` installer from the **Assets** section below.
            2. Double-click it to start the setup process.
            3. If you see the blue *"Windows protected your PC"* screen:
               - Click on **"More info"**
               - Then click on **"Run anyway"**
            4. Follow the installation wizard â€” nsbaci will be installed under **Program Files**.
            5. After installation, you can find nsbaci in your **Start Menu** or on your **Desktop** (if you selected that option).

            <p align="center">
              <img width="367" height="323" alt="Windows security screen" src="./assets/windows-security-screen.png" />
            </p>

            > **Note:** You do **not** need to install any additional dependencies.  
            > The installer already includes all required Qt libraries.

            ---

            **Release notes**
            ${{ steps.notes.outputs.notes }}
          files: |
            dist/windows/**/*.exe
            dist/linux/*.AppImage
          draft: false